# ------------------------------------------------------------
# ------------------------------------------------------------
# -------------  CloudCT Simulate  ---------------------------
# --------------  Run Paramaters  ----------------------------
# ------------------------------------------------------------
# ------------------------------------------------------------


# --------------------------------------------------
# -------------   Simulation flags  ----------------
# --------------------------------------------------
Log_Prefix: ''



DOFORWARD: True
DOINVERSE: True
DOCOSTEVAL: False

#DOFORWARD: True
#DOINVERSE: False
#DOCOSTEVAL: True 

# --------------------------------------------------
# --------------   Use Simple Imager?  --------------
# --------------------------------------------------
USE_SIMPLE_IMAGER: False
# if it's true, the imager is simple and not loaded from the imagers data set.


# --------------------------------------------------
# ------------   VIS Imager Parameters  ------------
# --------------------------------------------------
temperature: &temperature 15
vis_options:
  ImportConfigPath: '../CloudCT_notebooks/Gecko_config_20mGDS.json'
  #ImportConfigPath: '../CloudCT_notebooks/VIS_835-885_config_20mGDS.json'
  temperature: *temperature # celsius
  true_indices: [0,1,2,3,5,7,8,9]  # where imagers are located
  rays_per_pixel: 1
  rigid_sampling: True # True

# --------------------------------------------------
# ------------   SWIR Imager Parameters  ------------
# --------------------------------------------------
swir_options:
  ImportConfigPath: '../CloudCT_notebooks/Hypothetic_SWIR_camera_config_50m_nadir_resolution.json'
  temperature: *temperature # celsius
  true_indices: [4,6]   # where imagers are located, if true_indices: [], no swir imager will be simulated
  rays_per_pixel: 16
  rigid_sampling: True # True


# --------------------------------------------------
# -------------   Cloud & Air Field files  ---------
# --------------------------------------------------
#CloudFieldFile: '../synthetic_cloud_fields/jpl_les/rico32x37x26.txt' # 15.2, 06
#CloudFieldFile: '../synthetic_cloud_fields/wiz/BOMEX_22x27x49_23040.txt' # lwc: 0.4 reff: 7.8
#CloudFieldFile: '../synthetic_cloud_fields/wiz/BOMEX_24x22x21_43200.txt' # lwc: 0.8 reff: 6.2
#CloudFieldFile: '../synthetic_cloud_fields/wiz/BOMEX_35x28x54_55080.txt' # or _1d_reff , reff: 7.8 , lwc: 0.5
#CloudFieldFile: '../synthetic_cloud_fields/wiz/BOMEX_36x31x55_53760.txt' # reff: 9.4 lwc: 0.6 
#CloudFieldFile: '../synthetic_cloud_fields/wiz/BOMEX_13x25x36_28440.txt' # lwc: 0.4, reff: 6.2
#CloudFieldFile: '../synthetic_cloud_fields/wiz/BOMEX_13x25x36_28440_1d_reff_const_veff.txt'
CloudFieldFile: '../synthetic_cloud_fields/wiz/BOMEX_36000_39x44x30_4821' # 



#CloudFieldFile: '../WIZ_Clouds/cloud1261.txt'
AirFieldFile: '../ancillary_data/AFGL_summer_mid_lat.txt'  # Path to csv file which contains temperature measurements


# --------------------------------------------------
# ----------------  Number of Jobs  ----------------
# --------------------------------------------------
n_jobs: 50


# --------------------------------------------------
# ----------------   Orbit and GSD  ----------------
# --------------------------------------------------
Rsat: 500  # orbit altitude, km
#GSD: 0.02  # in km, it is the ground spatial resolution.
#GSD: 0.005 # /4
GSD: 0.02
# --------------------------------------------------
# -----------------   Wavelengths  -----------------
# --------------------------------------------------


# --------------------------------------------------
# -------------   Sun Azimuth & Zenith  ------------
# --------------------------------------------------
sun_azimuth: 90  # azimuth: 0 is beam going in positive X direction (North), 90 is positive Y (East).
sun_zenith: 165  # zenith: Solar beam zenith angle in range (90,180]


# --------------------------------------------------
# ------------   Number of Satellites  -------------
# --------------------------------------------------
SATS_NUMBER_SETUP: &num_sats 10  # satellites number to build the setup, for the inverse, we can use less satellites.
SATS_NUMBER_INVERSE: *num_sats  #10, how much satellites will be used for the inverse. TODO not in use
WIDEST_VIEW: False # If WIDEST_VIEW False, the setup is the original with 100km distance between satellites.
# If it is True the distance become 200km.
APPLY_VIEW_GEOMETRIC_SCALING: False
# If it is True, scale the gradient with geomitric scaling per view.

# --------------------------------------------------
# ---------  numerical & scene Parameters  ---------
# ---------  for RTE solver & solver init  ---------
# --------------------------------------------------
# later we must update it since it depends on the wavelegth.
# split_accuracy of 0.1 gives nice results, For the rico cloud i didn't see that decreasing the split accuracy improves the rec.
# so fo the rico loud Let's use split_accuracy = 0.1.
solar_fluxes_val: 1.0
split_accuracies_val: 0.1
surface_albedos_val: 0.05

# -------------------------------------------------
# -------------   mia table parameters  -----------
# -------------------------------------------------
mie_options:

  start_reff: 2.5 #4 # Starting effective radius [Micron]
  end_reff: 25.0
  num_reff: 100
  start_veff: 0.01
  end_veff: 0.53 #0.4 # return it to 0.4
  num_veff: 117
  radius_cutoff: 65.0 # The cutoff radius for the pdf averaging [Micron]
  wavelength_resolution: 0.001 # it is the delta in the wavelengths (microns) for the optical parameters avaraging inside shdom.
  
  #dr: &dr 0.2 # step in effective radius [Micron]
  #start_reff: &rs 2.5 # Starting effective radius [Micron]
  #end_reff: &rf 25.0
  #start_veff: &vs 0.01
  #end_veff: &vf 0.53 # return it to 0.4
  #num_veff: 127
  #radius_cutoff: 65.0 # The cutoff radius for the pdf averaging [Micron]
  #wavelength_resolution: 0.001 # it is the delta in the wavelengths (microns) for the optical parameters avaraging inside shdom.


# -------------------------------------------------
# -----------  Visualization parameters  ----------
# -------------------------------------------------
vizual_options:
  VISSETUP: False
  scale: 500
  axisWidth: 0.02
  axisLenght: 5000


# -------------------------------------------------
# ----------------  Forward parameters  -----------
# -------------------------------------------------
forward_options:

  # Rayleigh part:
  CENCEL_AIR: False # just for debugging, in runtime  must be false.
  air_num_points: 80  # Number of altitude grid points for the air volume
  air_max_alt: 100  # in km ,Maximum altitude for the air volume 
  # ------------------------------------------------------------
  
  SEE_IMAGES: False

  temp: 5900  # K,  units of W/(m^2))

  # ----------numerical & scene Parameters------------
  # --for RTE solver and initializtion of the solver--
  # --------------------------------------------------

  # note: when num_mu, num_phi are 16,32, the retrievals look better than with 8,16.
  num_mu: 8

  num_phi: 16

  max_total_mb: 100000.0

  rte_solver_max_iter: 150 # max number of iterations for rte solver

  solar_fluxes: [1, 1]  # unity flux, IT IS IMPORTANT HERE!

  split_accuracies: [0.1, 0.1] # 0.1 gives nice results, For the rico cloud i didn't see that decreasing the split accuracy improves the rec.
                               # so fo the rico loud Let's use split_accuracy = 0.1.

  surface_albedos: [0.05, 0.05]  # later we must update it since it depends on the wavelegth.

  adapt_grid_factor: 5  # TODO not in use

  solution_accuracy: 0.0001  # TODO not in use


# --------------------------------------------------
# --------------   Calibration --------------
# --------------------------------------------------
# equal bias and equal bias = False are meant for giving each image a different gain and bias
# since we add uncertainty in a loop on the imager it is not relevant, so keep on true
use_cal_uncertainty: True
uncertainty_options:
  use_bias: True
  use_gain: False
  max_bias: 5
  max_gain: 5
  
# -------------------------------------------------
# ----------------  inverse parameters  -----------
# -------------------------------------------------
inverse_options:

  erode_edges_init: False
  precond_grad: False
  force_1d_reff: False
  reff_smoothness_const: 0.0 # good 0.000001 # sloud be less than  0.00001
  # --------------------------------------------------
  # -------------   Radiance Threshold  ------------
  # --------------------------------------------------
  CloudCT_space_curve: True # do space curve implemented by CloudCT
  radiance_threshold_vis: [0.023] # Threshold is either a scalar or a list of length of measurements.
  radiance_threshold_swir: [0.017]
  # Shubi added but I need to accept:
  # radiance_threshold: 0.023 # Threshold is either a scalar or a list of length of measurements.
  # default_radiance_threshold: [0.02, 0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.02]
  # vis_radiance_threshold_path: '' # '..vis_thresholds.npy'
  # swir_radiance_threshold_path: '' # '..swir_thresholds.npy'
  #-------------
  #--------------------------------------------------------------
  
  SEE_SETUP: False

  SEE_IMAGES: False

  VIS_RESULTS3D: False  # show the results in 3D visualization

  #MICROPHYSICS: True # False for extinction
  MICROPHYSICS: True
  
  # if micropyhsics is  true, specify where to recover lwc / reff / veff or (reff and lwc)
  recover_type: 'reff_and_lwc' #reff_and_lwc' # expects: one of 'lwc' / 'reff' / 'veff' / 'reff_and_lwc'

  # Initialization and Medium parameters:
  lwc: 1.3 # 1  # init lwc of the generator
  reff: 10.2 # 7 # init reff of the generator
  veff: 0.1 # init veff of the generator

  # Scaling params when recovering reff and lwc:
  lwc_scaling_val: 10
  reff_scaling_val: 0.1
  #lwc_scaling_val: 15
  #reff_scaling_val: 0.01
  
  # if not microphysics:
  extinction: 0.01  # init extinction of the generator

  scripts_path: '../scripts'

  # TODO not in use
  stokes_weights: [1.0, 0.0, 0.0, 0.0] # Loss function weights for stokes vector components [I, Q, U, V]

  # INIT
  #init: 'FromMatFile'
  #mat_path = ../CloudCT_experiments/noisy_init/BOMOX_28440_10_noise.mat
  #init: 'Homogeneous' # init_generator = 'Homogeneous' it is the CloudGenerator from shdom.generate.py
  #init: 'LesFile'
  #LesFile_path: '../synthetic_cloud_fields/wiz/BOMEX_13x25x36_28440.txt' # lwc: 0.4, reff: 6.2
  init: 'Monotonous'
  #mono_in: 'reff'
  
  # droplets scatterer padding width.
  XPAD: 5 # pad in both sides in x axis
  YPAD: 5
  ZPAD: 5
  agreement: 0.9 # Space curving agreement among views
  
  # GT_USE
  use_const_veff: True
  add_rayleigh: True
  use_forward_mask: True
  use_forward_grid: True
  cloudct_use: True
  use_forward_albedo: True
  use_forward_phase: True
  if_save_gt_and_carver_masks: True
  if_save_final3d: True

  # optimization:
  globalopt: False  # Global optimization with basin-hopping. For more info: https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.basinhopping.html.
  maxiter: 1000  # Maximum number of L-BFGS iterations. For more info: https://docs.scipy.org/doc/scipy/reference/optimize.minimize-lbfgsb.html.
  maxls: 30  # Maximum number of line search steps (per iteration). For more info: https://docs.scipy.org/doc/scipy/reference/optimize.minimize-lbfgsb.html.
  disp: True  # Display optimization progression.
  gtol: 1e-16  # Stop criteria for the maximum projected gradient. # For more info: https://docs.scipy.org/doc/scipy/reference/optimize.minimize-lbfgsb.html
  ftol: 1e-16  # Stop criteria for the relative change in loss function. # For more info: https://docs.scipy.org/doc/scipy/reference/optimize.minimize-lbfgsb.html
  loss_type: 'l2'  # Different loss functions for optimization. Currently only l2 is supported.
  extinction_optimizer: 'optimize_extinction_lbfgs.py'
  microphysics_optimizer: 'optimize_microphysics_lbfgs.py'


# ----------------------------------------------
# -------------------  Others  -----------------
# ----------------------------------------------

# Sometimes it is more convenient to use wide fov to see the whole cloud from all the view points.
# so the FOV is also tuned:
IFTUNE_CAM: True

